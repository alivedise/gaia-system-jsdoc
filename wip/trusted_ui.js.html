<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>FirefoxOS - SystemApp - API documentation : Source: trusted_ui.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link href="styles/bootstrap.css" rel="stylesheet">
    <link href="styles/docs.css" rel="stylesheet">
    <link href="styles/bootstrap-custom.css" rel="stylesheet">
    <link href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
  </head>
  <body>
    <header class="header navbar navbar-inverse">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="#"><strong>FirefoxOS SystemApp</strong> API documentation</a>
        </div>
      </div>
    </header>

    <div class="container-fluid">
      <div class="row-fluid">
          <div class="span4">
              <h2><a href="index.html">Index</a></h2><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Modules</li><li><a href="module-ActivityWindowFactory.html">ActivityWindowFactory</a></li>
<li><a href="module-AppWindowFactory.html">AppWindowFactory</a></li>
<li><a href="module-AppWindowManager.html">AppWindowManager</a></li>
<li><a href="module-HomescreenLauncher.html">HomescreenLauncher</a></li>
<li><a href="module-LayoutManager.html">LayoutManager</a></li>
<li><a href="module-OrientationManager.html">OrientationManager</a></li>
<li><a href="module-System.html">System</a></li>
<li><a href="module-WrapperFactory.html">WrapperFactory</a></li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Classes</li><li><a href="ActivityWindow.html"><i class="icon-shield" style="color: #0186d1"></i> ActivityWindow</a></li><li><a href="AppAuthenticationDialog.html"><i class="icon-shield" style="color: #0186d1"></i> AppAuthenticationDialog</a></li><li><a href="AppChrome.html"><i class="icon-shield" style="color: #0186d1"></i> AppChrome</a></li><li><a href="AppModalDialog.html"><i class="icon-shield" style="color: #0186d1"></i> AppModalDialog</a></li><li><a href="AppTransitionController.html"><i class="icon-shield" style="color: #0186d1"></i> AppTransitionController</a></li><li><a href="AppWindow.html"><i class="icon-shield" style="color: #0186d1"></i> AppWindow</a></li><li><a href="BaseUI.html"><i class="icon-shield" style="color: #0186d1"></i> BaseUI</a></li><li><a href="BrowserFrame.html"><i class="icon-shield" style="color: #0186d1"></i> BrowserFrame</a></li><li><a href="Clock.html"><i class="icon-shield" style="color: #0186d1"></i> Clock</a></li><li><a href="HomescreenWindow.html"><i class="icon-shield" style="color: #0186d1"></i> HomescreenWindow</a></li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Public Events</li><li><a href="ActivityWindow.html#event:activitybackground"><i class="icon-bell-alt" style="color: yellow"></i> activitybackground <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityclose"><i class="icon-bell-alt" style="color: yellow"></i> activityclose <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityclosing"><i class="icon-bell-alt" style="color: yellow"></i> activityclosing <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activitycreated"><i class="icon-bell-alt" style="color: yellow"></i> activitycreated <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityforeground"><i class="icon-bell-alt" style="color: yellow"></i> activityforeground <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityopen"><i class="icon-bell-alt" style="color: yellow"></i> activityopen <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityopening"><i class="icon-bell-alt" style="color: yellow"></i> activityopening <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityrendered"><i class="icon-bell-alt" style="color: yellow"></i> activityrendered <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityterminated"><i class="icon-bell-alt" style="color: yellow"></i> activityterminated <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activitywillrender"><i class="icon-bell-alt" style="color: yellow"></i> activitywillrender <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="AppWindow.html#event:appclose"><i class="icon-bell-alt" style="color: yellow"></i> appclose <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appclosing"><i class="icon-bell-alt" style="color: yellow"></i> appclosing <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appcreated"><i class="icon-bell-alt" style="color: yellow"></i> appcreated <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appdestroyed"><i class="icon-bell-alt" style="color: yellow"></i> appdestroyed <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appopen"><i class="icon-bell-alt" style="color: yellow"></i> appopen <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appopening"><i class="icon-bell-alt" style="color: yellow"></i> appopening <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:apprendered"><i class="icon-bell-alt" style="color: yellow"></i> apprendered <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:apprequestclose"><i class="icon-bell-alt" style="color: yellow"></i> apprequestclose <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:apprequestopen"><i class="icon-bell-alt" style="color: yellow"></i> apprequestopen <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appresize"><i class="icon-bell-alt" style="color: yellow"></i> appresize <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appterminated"><i class="icon-bell-alt" style="color: yellow"></i> appterminated <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appwilldestroy"><i class="icon-bell-alt" style="color: yellow"></i> appwilldestroy <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appwillrender"><i class="icon-bell-alt" style="color: yellow"></i> appwillrender <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenbackground"><i class="icon-bell-alt" style="color: yellow"></i> homescreenbackground <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenclose"><i class="icon-bell-alt" style="color: yellow"></i> homescreenclose <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenclosing"><i class="icon-bell-alt" style="color: yellow"></i> homescreenclosing <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreencreated"><i class="icon-bell-alt" style="color: yellow"></i> homescreencreated <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenforeground"><i class="icon-bell-alt" style="color: yellow"></i> homescreenforeground <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenopen"><i class="icon-bell-alt" style="color: yellow"></i> homescreenopen <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenopening"><i class="icon-bell-alt" style="color: yellow"></i> homescreenopening <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenrendered"><i class="icon-bell-alt" style="color: yellow"></i> homescreenrendered <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenterminated"><i class="icon-bell-alt" style="color: yellow"></i> homescreenterminated <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenwillrender"><i class="icon-bell-alt" style="color: yellow"></i> homescreenwillrender <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="module-LayoutManager.html#event:system-resize"><i class="icon-bell-alt" style="color: yellow"></i> system-resize <span class="label label-inverse pull-right">module:LayoutManager</span></a></li><li><a href="module-OrientationManager.html#event:reset-orientation"><i class="icon-bell-alt" style="color: yellow"></i> reset-orientation <span class="label label-inverse pull-right">module:OrientationManager</span></a></li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Private Events</li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Mixins</li><li><a href="BrowserMixin.html"><i class="icon-beaker"></i> BrowserMixin</a></li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Global</li><li><a href="global.html#LockScreen"><i class="icon-globe" style="color: black;"></i> LockScreen</a></li><li><a href="global.html#SystemDialog"><i class="icon-globe" style="color: black;"></i> SystemDialog</a></li><li><a href="global.html#SystemScreen"><i class="icon-globe" style="color: black;"></i> SystemScreen</a></li></ul></div>
          </div>

          <div class="span8">
              <h1 class="page-header">Source: trusted_ui.js</h1>
              


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/* -*- Mode: js2; js2-basic-offset: 2; indent-tabs-mode: nil -*- */
/* vim: set ft=javascript sw=2 ts=2 autoindent cindent expandtab: */

'use strict';

var TrustedUIManager = {

  get currentStack() {
    if (!this._dialogStacks[this._lastDisplayedApp]) {
      this._dialogStacks[this._lastDisplayedApp] = [];
    }
    return this._dialogStacks[this._lastDisplayedApp];
  },

  _dialogStacks: {},
  _lastDisplayedApp: null,

  overlay: document.getElementById('dialog-overlay'),

  popupContainer: document.getElementById('trustedui-container'),

  popupContainerInner: document.getElementById('trustedui-inner'),

  container: document.getElementById('trustedui-frame-container'),

  dialogTitle: document.getElementById('trustedui-title'),

  screen: document.getElementById('screen'),

  loadingIcon: document.getElementById('statusbar-loading'),

  throbber: document.getElementById('trustedui-throbber'),

  closeButton: document.getElementById('trustedui-close'),

  hasTrustedUI: function trui_hasTrustedUI(origin) {
    return (this._dialogStacks[origin] &amp;&amp; this._dialogStacks[origin].length);
  },

  getDialogFromOrigin: function trui_getDialogFromOrigin(origin) {
    if (!origin || !this.hasTrustedUI(origin))
      return false;
    var stack = this._dialogStacks[origin];
    return stack[stack.length - 1];
  },

  init: function trui_init() {
    window.addEventListener('home', this);
    window.addEventListener('holdhome', this);
    window.addEventListener('appwillopen', this);
    window.addEventListener('appopen', this);
    window.addEventListener('appwillclose', this);
    window.addEventListener('appcreated', this);
    window.addEventListener('appterminated', this);
    window.addEventListener('keyboardhide', this);
    window.addEventListener('keyboardchange', this);
    this.closeButton.addEventListener('click', this);
  },

  open: function trui_open(name, frame, chromeEventId, onCancelCB) {
    screen.mozLockOrientation('portrait');
    this._hideAllFrames();
    if (this.currentStack.length) {
      this._makeDialogHidden(this._getTopDialog());
      this._pushNewDialog(name, frame, chromeEventId, onCancelCB);
    } else {
      // first time, spin back to home screen first
      this.popupContainer.classList.add('up');
      this.popupContainer.classList.remove('closing');
      this._hideCallerApp(this._lastDisplayedApp, function openTrustedUI() {
        this.popupContainer.classList.remove('up');
        this._pushNewDialog(name, frame, chromeEventId, onCancelCB);
      }.bind(this));
    }
  },

  close: function trui_close(chromeEventId, callback, origin) {
    var stackSize = origin ? this._dialogStacks[origin].length :
                             this.currentStack.length;

    this._restoreOrientation();

    if (callback)
      callback();

    if (stackSize === 0) {
      // Nothing to close.  what are you doing?
      return;
    } else if (stackSize === 1) {
      // Only one dialog, so transition back to main app.
      var self = this;
      var container = this.popupContainer;
      if (!CardsView.cardSwitcherIsShown()) {
        if (!origin) {
          this._restoreCallerApp(this._lastDisplayedApp);
        }
        container.addEventListener('transitionend', function wait(event) {
          this.removeEventListener('transitionend', wait);
          self._closeDialog(chromeEventId, origin);
        });
      } else {
        if (!origin) {
          this._restoreCallerApp(this._lastDisplayedApp);
        }
        this._closeDialog(chromeEventId, origin);
      }

      // The css transition caused by the removal of the trustedui
      // class by the hide() method will trigger a 'transitionend'
      // event ultimately to be fired.
      this._hide();

      window.focus();
    } else {
      this._closeDialog(chromeEventId, origin);
    }
  },

  isVisible: function trui_show() {
    return this.screen.classList.contains('trustedui');
  },

  _hideTrustedApp: function trui_hideTrustedApp() {
    var self = this;
    this.popupContainer.classList.add('closing');
    this.popupContainer.addEventListener('transitionend', function hide() {
      this.removeEventListener('transitionend', hide);
      self._hide();
    });
  },

  _reopenTrustedApp: function trui_reopenTrustedApp() {
    this._hideAllFrames();
    var dialog = this._getTopDialog();
    this._makeDialogVisible(dialog);
    this.popupContainer.classList.add('closing');
    this._show();
    this.popupContainer.classList.remove('closing');
  },

  _hideCallerApp: function trui_hideCallerApp(origin, callback) {
    var app = AppWindowManager.getApp(origin);
    if (app == null || app.isHomescreen) {
      return;
    }

    this.publish('trusteduishow', { origin: origin });
    var frame = app.frame;
    frame.classList.add('back');
    frame.classList.remove('restored');
    if (callback) {
      frame.addEventListener('transitionend', function execCallback() {
        frame.style.visibility = 'hidden';
        frame.removeEventListener('transitionend', execCallback);
        callback();
      });
    }
  },

  publish: function trui_publish(evtName, detail) {
    var evt = new CustomEvent(evtName, {
      bubbles: true,
      cancelable: true,
      detail: detail
    });

    window.dispatchEvent(evt);
  },

  _restoreCallerApp: function trui_restoreCallerApp(origin) {
    var frame = AppWindowManager.getRunningApps()[origin].frame;
    frame.style.visibility = 'visible';
    frame.classList.remove('back');
    if (!AppWindowManager.getActiveApp().isHomescreen) {
      this.publish('trusteduihide', { origin: origin });
    }
    if (AppWindowManager.getDisplayedApp() == origin) {
      frame.classList.add('restored');
      frame.addEventListener('transitionend', function removeRestored() {
        frame.removeEventListener('transitionend', removeRestored);
        frame.classList.remove('restored');
      });
    }
  },

  _dispatchCloseEvent: function dispatchCloseEvent(eventId) {
    if (!eventId) {
      return;
    }
    var event = document.createEvent('customEvent');
    var details = {
      id: eventId,
      type: 'cancel',
      errorMsg: 'DIALOG_CLOSED_BY_USER'
    };
    event.initCustomEvent('mozContentEvent', true, true, details);
    window.dispatchEvent(event);
  },

  _getTopDialog: function trui_getTopDialog(origin) {
    // Get the topmost dialog for the _lastDisplayedApp, the given origin
    // or null.
    if (origin) {
      var stack = this._dialogStacks[origin];
      return stack[stack.length - 1];
    }
    return this.currentStack[this.currentStack.length - 1];
  },

  _pushNewDialog: function trui_PushNewDialog(name, frame, chromeEventId,
                                              onCancelCB) {
    // Add some data attributes to the frame.
    var dataset = frame.dataset;
    dataset.frameType = 'popup';
    dataset.frameName = frame.name;
    dataset.frameOrigin = this._lastDisplayedApp;

    // Add mozbrowser listeners.
    frame.addEventListener('mozbrowserloadstart',
                           this.handleBrowserEvent);
    frame.addEventListener('mozbrowserloadend',
                           this.handleBrowserEvent);

    // Make a shiny new dialog object.
    var dialog = {
      name: name,
      frame: frame,
      chromeEventId: chromeEventId,
      onCancelCB: onCancelCB
    };

    // Push and show.
    this.currentStack.push(dialog);
    this.dialogTitle.textContent = dialog.name;
    this.container.appendChild(dialog.frame);
    this._makeDialogVisible(dialog);
  },

  _makeDialogVisible: function trui_makeDialogVisible(dialog) {
    // make sure the trusty ui is visible
    this.popupContainer.classList.remove('closing');
    this._show();

    // ensure the frame is visible and the dialog title is correct.
    dialog.frame.classList.add('selected');
    this.dialogTitle.textContent = dialog.name;
  },

  _makeDialogHidden: function trui_makeDialogHidden(dialog) {
    if (!dialog)
      return;
    this._restoreOrientation();
    dialog.frame.classList.remove('selected');
  },

  _restoreOrientation: function trui_restoreOrientation() {
    window.dispatchEvent(new Event('trusteduiclose'));
  },

  /**
   * Close the dialog identified by the chromeEventId.
   */
  _closeDialog: function trui_closeDialog(chromeEventId, origin) {
    var stack = origin ? this._dialogStacks[origin] :
                         this.currentStack;
    if (stack.length === 0) {
      return;
    }

    var found = false;
    for (var i = 0; i &lt; stack.length; i++) {
      if (stack[i].chromeEventId === chromeEventId) {
        var frame = stack.splice(i, 1)[0].frame;
        frame.removeEventListener('mozbrowserloadstart',
                                  this.handleBrowserEvent);
        frame.removeEventListener('mozbrowserloadend',
                                  this.handleBrowserEvent);
        this.container.removeChild(frame);
        found = true;
        break;
      }
    }

    if (found &amp;&amp; stack.length) {
      this._makeDialogVisible(this._getTopDialog());
    }
  },

  _hide: function trui_hide() {
    this.screen.classList.remove('trustedui');
  },

  _show: function trui_show() {
    this.screen.classList.add('trustedui');
  },

  _setHeight: function trui_setHeight(height) {
    this.overlay.style.height = height + 'px';
  },

  /*
   * _destroyDialog: internal method called when the dialog is closed
   * by user action (canceled), or when 'appterminated' is received.
   * In either case, notify the caller.
   */
  _destroyDialog: function trui_destroyDialog(origin) {
    var stack = this.currentStack;
    if (origin) {
      stack = this._dialogStacks[origin];
    }

    if (stack.length === 0)
      return;

    // If the user closed a trusty UI dialog, they probably meant
    // to close every dialog.
    for (var i = 0, toClose = stack.length; i &lt; toClose; i++) {
      var dialog = this._getTopDialog(origin);

      // First, send a chrome event saying we've been canceled
      this._dispatchCloseEvent(dialog.chromeEventId);

      // Now close and fire the cancel callback, if it exists
      this.close(dialog.chromeEventId, dialog.onCancelCB, origin);
    }
    this._hide();
    this.popupContainer.classList.remove('closing');
  },

  _hideAllFrames: function trui_hideAllFrames() {
    var selectedFrames = this.container.querySelectorAll('iframe.selected');
    for (var i = 0; i &lt; selectedFrames.length; i++) {
      selectedFrames[i].classList.remove('selected');
    }
  },

  handleEvent: function trui_handleEvent(evt) {
    switch (evt.type) {
      case 'home':
      case 'holdhome':
        if (!this.isVisible())
          return;

        this._hideTrustedApp();
        break;
      case 'click':
        // Close-button clicked
        this._destroyDialog();
        break;
      case 'appterminated':
        this._destroyDialog(evt.detail.origin);
        break;
      case 'appcreated':
        // XXX: This is a quick fix for sometimes an app is created
        // at background and never got brought to foregroud.
        // We ought not to repy on app* events but embed us
        // in appWindow class to achieve a true fix.
        // See https://bugzilla.mozilla.org/show_bug.cgi?id=911880
        if (!this._dialogStacks[evt.detail.origin]) {
          this._dialogStacks[evt.detail.origin] = [];
        }
        break;
      case 'appwillopen':
        var app = evt.detail;
        // Hiding trustedUI when coming from Activity
        if (this.isVisible())
          this._hideTrustedApp();

        // Ignore homescreen
        if (app.isHomescreen)
          return;
        this._lastDisplayedApp = app.origin;
        if (this.currentStack.length) {
          // Reopening an app with trustedUI
          this.popupContainer.classList.remove('up');
          this._makeDialogVisible(this._getTopDialog());
          this._hideCallerApp(this._lastDisplayedApp);
          this._reopenTrustedApp();
        }
        break;
      case 'appopen':
        if (this.currentStack.length) {
          screen.mozLockOrientation('portrait');
        }
        break;
      case 'appwillclose':
        if (this.isVisible())
          return;
        var dialog = this._getTopDialog();
        this._makeDialogHidden(dialog);
        this._hide();
        break;
      case 'keyboardchange':
        var keyboardHeight = KeyboardManager.getHeight();
        this._setHeight(window.innerHeight - StatusBar.height - keyboardHeight);
        break;
      case 'keyboardhide':
        this._setHeight(window.innerHeight - StatusBar.height);
        break;
    }
  },

  handleBrowserEvent: function trui_handleBrowserEvent(evt) {
    switch (evt.type) {
      case 'mozbrowserloadstart':
        TrustedUIManager.throbber.classList.add('loading');
        break;
      case 'mozbrowserloadend':
        TrustedUIManager.throbber.classList.remove('loading');
        break;
    }
  }

};

TrustedUIManager.init();

</code></pre>
        </article>
    </section>




          </div>
      </div>

        <br clear="both">

      <footer>
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-dev</a> on Tue Dec 03 2013 12:36:36 GMT+0800 (CST)
        <br>
      </footer>
      <script> prettyPrint(); </script>
    </div>
  </body>
</html>
