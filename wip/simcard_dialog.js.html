<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>FirefoxOS - SystemApp - API documentation : Source: simcard_dialog.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link href="styles/bootstrap.css" rel="stylesheet">
    <link href="styles/docs.css" rel="stylesheet">
    <link href="styles/bootstrap-custom.css" rel="stylesheet">
    <link href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
  </head>
  <body>
    <header class="header navbar navbar-inverse">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="#"><strong>FirefoxOS SystemApp</strong> API documentation</a>
        </div>
      </div>
    </header>

    <div class="container-fluid">
      <div class="row-fluid">
          <div class="span4">
              <h2><a href="index.html">Index</a></h2><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Modules</li><li><a href="module-ActivityWindowFactory.html">ActivityWindowFactory</a></li>
<li><a href="module-AppWindowFactory.html">AppWindowFactory</a></li>
<li><a href="module-AppWindowManager.html">AppWindowManager</a></li>
<li><a href="module-HomescreenLauncher.html">HomescreenLauncher</a></li>
<li><a href="module-LayoutManager.html">LayoutManager</a></li>
<li><a href="module-OrientationManager.html">OrientationManager</a></li>
<li><a href="module-System.html">System</a></li>
<li><a href="module-WrapperFactory.html">WrapperFactory</a></li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Classes</li><li><a href="ActivityWindow.html"><i class="icon-shield" style="color: #0186d1"></i> ActivityWindow</a></li><li><a href="AppAuthenticationDialog.html"><i class="icon-shield" style="color: #0186d1"></i> AppAuthenticationDialog</a></li><li><a href="AppChrome.html"><i class="icon-shield" style="color: #0186d1"></i> AppChrome</a></li><li><a href="AppModalDialog.html"><i class="icon-shield" style="color: #0186d1"></i> AppModalDialog</a></li><li><a href="AppTransitionController.html"><i class="icon-shield" style="color: #0186d1"></i> AppTransitionController</a></li><li><a href="AppWindow.html"><i class="icon-shield" style="color: #0186d1"></i> AppWindow</a></li><li><a href="BaseUI.html"><i class="icon-shield" style="color: #0186d1"></i> BaseUI</a></li><li><a href="BrowserFrame.html"><i class="icon-shield" style="color: #0186d1"></i> BrowserFrame</a></li><li><a href="Clock.html"><i class="icon-shield" style="color: #0186d1"></i> Clock</a></li><li><a href="HomescreenWindow.html"><i class="icon-shield" style="color: #0186d1"></i> HomescreenWindow</a></li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Public Events</li><li><a href="ActivityWindow.html#event:activitybackground"><i class="icon-bell-alt" style="color: yellow"></i> activitybackground <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityclose"><i class="icon-bell-alt" style="color: yellow"></i> activityclose <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityclosing"><i class="icon-bell-alt" style="color: yellow"></i> activityclosing <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activitycreated"><i class="icon-bell-alt" style="color: yellow"></i> activitycreated <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityforeground"><i class="icon-bell-alt" style="color: yellow"></i> activityforeground <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityopen"><i class="icon-bell-alt" style="color: yellow"></i> activityopen <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityopening"><i class="icon-bell-alt" style="color: yellow"></i> activityopening <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityrendered"><i class="icon-bell-alt" style="color: yellow"></i> activityrendered <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activityterminated"><i class="icon-bell-alt" style="color: yellow"></i> activityterminated <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="ActivityWindow.html#event:activitywillrender"><i class="icon-bell-alt" style="color: yellow"></i> activitywillrender <span class="label label-inverse pull-right">ActivityWindow</span></a></li><li><a href="AppWindow.html#event:appclose"><i class="icon-bell-alt" style="color: yellow"></i> appclose <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appclosing"><i class="icon-bell-alt" style="color: yellow"></i> appclosing <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appcreated"><i class="icon-bell-alt" style="color: yellow"></i> appcreated <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appdestroyed"><i class="icon-bell-alt" style="color: yellow"></i> appdestroyed <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appopen"><i class="icon-bell-alt" style="color: yellow"></i> appopen <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appopening"><i class="icon-bell-alt" style="color: yellow"></i> appopening <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:apprendered"><i class="icon-bell-alt" style="color: yellow"></i> apprendered <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:apprequestclose"><i class="icon-bell-alt" style="color: yellow"></i> apprequestclose <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:apprequestopen"><i class="icon-bell-alt" style="color: yellow"></i> apprequestopen <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appresize"><i class="icon-bell-alt" style="color: yellow"></i> appresize <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appterminated"><i class="icon-bell-alt" style="color: yellow"></i> appterminated <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appwilldestroy"><i class="icon-bell-alt" style="color: yellow"></i> appwilldestroy <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="AppWindow.html#event:appwillrender"><i class="icon-bell-alt" style="color: yellow"></i> appwillrender <span class="label label-inverse pull-right">AppWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenbackground"><i class="icon-bell-alt" style="color: yellow"></i> homescreenbackground <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenclose"><i class="icon-bell-alt" style="color: yellow"></i> homescreenclose <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenclosing"><i class="icon-bell-alt" style="color: yellow"></i> homescreenclosing <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreencreated"><i class="icon-bell-alt" style="color: yellow"></i> homescreencreated <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenforeground"><i class="icon-bell-alt" style="color: yellow"></i> homescreenforeground <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenopen"><i class="icon-bell-alt" style="color: yellow"></i> homescreenopen <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenopening"><i class="icon-bell-alt" style="color: yellow"></i> homescreenopening <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenrendered"><i class="icon-bell-alt" style="color: yellow"></i> homescreenrendered <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenterminated"><i class="icon-bell-alt" style="color: yellow"></i> homescreenterminated <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="HomescreenWindow.html#event:homescreenwillrender"><i class="icon-bell-alt" style="color: yellow"></i> homescreenwillrender <span class="label label-inverse pull-right">HomescreenWindow</span></a></li><li><a href="module-LayoutManager.html#event:system-resize"><i class="icon-bell-alt" style="color: yellow"></i> system-resize <span class="label label-inverse pull-right">module:LayoutManager</span></a></li><li><a href="module-OrientationManager.html#event:reset-orientation"><i class="icon-bell-alt" style="color: yellow"></i> reset-orientation <span class="label label-inverse pull-right">module:OrientationManager</span></a></li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Private Events</li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Mixins</li><li><a href="BrowserMixin.html"><i class="icon-beaker"></i> BrowserMixin</a></li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Global</li><li><a href="global.html#LockScreen"><i class="icon-globe" style="color: black;"></i> LockScreen</a></li><li><a href="global.html#SystemDialog"><i class="icon-globe" style="color: black;"></i> SystemDialog</a></li><li><a href="global.html#SystemScreen"><i class="icon-globe" style="color: black;"></i> SystemScreen</a></li></ul></div>
          </div>

          <div class="span8">
              <h1 class="page-header">Source: simcard_dialog.js</h1>
              


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/* -*- Mode: js; js-indent-level: 2; indent-tabs-mode: nil -*- */
/* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab: */

'use strict';

var SimPinDialog = {
  dialogTitle: document.querySelector('#simpin-dialog header h1'),
  dialogDone: document.querySelector('#simpin-dialog button[type="submit"]'),
  dialogClose: document.querySelector('#simpin-dialog button[type="reset"]'),

  pinArea: document.getElementById('pinArea'),
  pukArea: document.getElementById('pukArea'),
  xckArea: document.getElementById('xckArea'),
  newPinArea: document.getElementById('newPinArea'),
  confirmPinArea: document.getElementById('confirmPinArea'),

  pinInput: null,
  pukInput: null,
  xckInput: null,
  newPinInput: null,
  confirmPinInput: null,

  triesLeftMsg: document.getElementById('triesLeft'),

  errorMsg: document.getElementById('errorMsg'),
  errorMsgHeader: document.getElementById('messageHeader'),
  errorMsgBody: document.getElementById('messageBody'),

  mobileConnection: null,

  lockType: 'pin',
  action: 'unlock',

  lockTypeMap: {
    'pinRequired': 'pin',
    'pukRequired': 'puk',
    'networkLocked': 'nck',
    'corporateLocked': 'cck',
    'serviceProviderLocked': 'spck'
  },

  getNumberPasswordInputField: function spl_wrapNumberInput(name) {
    var inputField = document.querySelector('input[name="' + name + '"]');
    var self = this;

    inputField.addEventListener('input', function(evt) {
      if (evt.target !== inputField)
        return;

      checkDialogDone();
    });

    inputField.addEventListener('focus', function() {
      checkDialogDone();
    });

    function checkDialogDone() {
      if (inputField.value.length >= 4)
        self.dialogDone.disabled = false;
      else
        self.dialogDone.disabled = true;
    }


    return inputField;
  },

  handleCardState: function spl_handleCardState() {
    var _ = navigator.mozL10n.get;

    var cardState = IccHelper.cardState;
    var lockType = this.lockTypeMap[cardState];
    IccHelper.getCardLockRetryCount(lockType, (function(retryCount) {
      if (retryCount) {
        var l10nArgs = { n: retryCount };
        this.triesLeftMsg.textContent = _('inputCodeRetriesLeft', l10nArgs);
        this.triesLeftMsg.hidden = false;
      }
    }).bind(this));

    switch (lockType) {
      case 'pin':
        this.lockType = lockType;
        this.errorMsg.hidden = true;
        this.inputFieldControl(true, false, false, false);
        this.pinInput.focus();
        break;
      case 'puk':
        this.lockType = lockType;
        this.errorMsgHeader.textContent = _('simCardLockedMsg') || '';
        this.errorMsgBody.textContent = _('enterPukMsg') || '';
        this.errorMsg.hidden = false;
        this.inputFieldControl(false, true, false, true);
        this.pukInput.focus();
        break;
      case 'nck':
      case 'cck':
      case 'spck':
        this.lockType = lockType;
        this.errorMsg.hidden = true;
        this.inputFieldControl(false, false, true, false);
        var desc = this.xckArea.querySelector('div[name="xckDesc"]');
        desc.textContent = _(lockType + 'Code');
        this.xckInput.focus();
        break;
      default:
        this.skip();
        break;
    }
    this.dialogTitle.textContent = _(this.lockType + 'Title') || '';
  },

  handleError: function spl_handleLockError(evt) {
    var retry = (evt.retryCount) ? evt.retryCount : -1;
    this.showErrorMsg(retry, evt.lockType);
    if (retry === -1) {
      this.skip();
      return;
    }
    if (evt.lockType === 'pin') {
      this.pinInput.focus();
    } else if (evt.lockType === 'puk') {
      this.pukInput.focus();
    } else {
      this.xckInput.focus();
    }
  },

  showErrorMsg: function spl_showErrorMsg(retry, type) {
    var _ = navigator.mozL10n.get;
    var l10nArgs = { n: retry };

    this.triesLeftMsg.textContent = _('inputCodeRetriesLeft', l10nArgs);
    this.errorMsgHeader.textContent = _(type + 'ErrorMsg');
    if (retry !== 1) {
      this.errorMsgBody.textContent = _(type + 'AttemptMsg2', l10nArgs);
    } else {
      this.errorMsgBody.textContent = _(type + 'LastChanceMsg');
    }

    this.errorMsg.hidden = false;
  },

  unlockPin: function spl_unlockPin() {
    var pin = this.pinInput.value;
    if (pin === '')
      return;

    var options = {lockType: 'pin', pin: pin };
    this.unlockCardLock(options);
    this.clear();
  },

  unlockPuk: function spl_unlockPuk() {
    var _ = navigator.mozL10n.get;

    var puk = this.pukInput.value;
    var newPin = this.newPinInput.value;
    var confirmPin = this.confirmPinInput.value;
    if (puk === '' || newPin === '' || confirmPin === '')
      return;

    if (newPin !== confirmPin) {
      this.errorMsgHeader.textContent = _('newPinErrorMsg');
      this.errorMsgBody.textContent = '';
      this.errorMsg.hidden = false;
      return;
    }
    var options = {lockType: 'puk', puk: puk, newPin: newPin };
    this.unlockCardLock(options);
    this.clear();
  },

  unlockXck: function spl_unlockXck() {
    var xck = this.xckInput.value;
    if (xck === '')
      return;

    var options = {lockType: this.lockType, pin: xck };
    this.unlockCardLock(options);
    this.clear();
  },

  unlockCardLock: function spl_unlockCardLock(options) {
    var req = IccHelper.unlockCardLock(options);
    req.onsuccess = this.close.bind(this, 'success');
    req.onerror = (function spl_unlockCardLockError() {
      this.handleError(req.error);
    }).bind(this);
  },

  enableLock: function spl_enableLock() {
    var pin = this.pinInput.value;
    if (pin === '')
      return;

    var enabled = SimPinLock.simPinCheckBox.checked;
    var options = {lockType: 'pin', pin: pin, enabled: enabled};
    this.setCardLock(options);
    this.clear();
  },

  changePin: function spl_changePin() {
    var _ = navigator.mozL10n.get;

    var pin = this.pinInput.value;
    var newPin = this.newPinInput.value;
    var confirmPin = this.confirmPinInput.value;
    if (pin === '' || newPin === '' || confirmPin === '')
      return;

    if (newPin !== confirmPin) {
      this.errorMsgHeader.textContent = _('newPinErrorMsg');
      this.errorMsgBody.textContent = '';
      this.errorMsg.hidden = false;
      return;
    }
    var options = {lockType: 'pin', pin: pin, newPin: newPin};
    this.setCardLock(options);
    this.clear();
  },

  setCardLock: function spl_setCardLock(options) {
    var req = IccHelper.setCardLock(options);
    req.onsuccess = this.close.bind(this, 'success');
  },
  inputFieldControl: function spl_inputField(isPin, isPuk, isXck, isNewPin) {
    this.pinArea.hidden = !isPin;
    this.pukArea.hidden = !isPuk;
    this.xckArea.hidden = !isXck;
    this.newPinArea.hidden = !isNewPin;
    this.confirmPinArea.hidden = !isNewPin;
  },

  verify: function spl_verify() {
    switch (this.action) {
      case 'unlock':
        if (this.lockType === 'pin')
          this.unlockPin();
        else if (this.lockType === 'puk') {
          this.unlockPuk();
        } else {
          this.unlockXck();
        }
        break;
      case 'enable':
        this.enableLock();
        break;
      case 'changePin':
        this.changePin();
        break;
    }
    return false;
  },

  onHide: function spl_onHide(reason) {
    this.clear();
    if (this.onclose)
      this.onclose(reason);
  },

  clear: function spl_clear() {
    this.errorMsg.hidden = true;
    this.pinInput.value = '';
    this.pinInput.blur();
    this.pukInput.value = '';
    this.pukInput.blur();
    this.xckInput.value = '';
    this.xckInput.blur();
    this.newPinInput.value = '';
    this.newPinInput.blur();
    this.confirmPinInput.value = '';
    this.confirmPinInput.blur();
  },

  onclose: null,

  _visible: false,

  get visible() {
    return this._visible;
  },

  /**
   * Show the SIM pin dialog
   * @param {String}   action  Name of the action to execute,
   *                           either: unlock, enable or changePin.
   * @param {Function} title   Optional function called when dialog is closed.
   *                           Receive a single argument being the reason of
   *                           dialog closing: success, skip, home or holdhome.
   */
  show: function spl_show(action, onclose) {
    var _ = navigator.mozL10n.get;

    // Hide the utility tray to avoid overlapping the SIM Pin dialog
    UtilityTray.hide(true);

    this.systemDialog.show();
    this._visible = true;
    this.action = action;
    this.lockType = 'pin';
    switch (action) {
      case 'unlock':
        this.handleCardState();
        break;
      case 'enable':
        this.inputFieldControl(true, false, false, false);
        this.dialogTitle.textContent = _('pinTitle') || '';
        break;
      case 'changePin':
        this.inputFieldControl(true, false, false, true);
        this.dialogTitle.textContent = _('newpinTitle') || '';
        break;
    }

    if (onclose &amp;&amp; typeof onclose === 'function')
      this.onclose = onclose;
  },

  close: function spl_close(reason) {
    this.systemDialog.hide(reason);
    this._visible = false;
  },

  skip: function spl_skip() {
    this.close('skip');
    return false;
  },

  init: function spl_init() {
    this.systemDialog = SystemDialog('simpin-dialog', {
                                       onHide: this.onHide.bind(this)
                                     });

    // XXX: check bug-926169
    // this is used to keep all tests passing while introducing multi-sim APIs
    this.mobileConnection = window.navigator.mozMobileConnection ||
      window.navigator.mozMobileConnections &amp;&amp;
        window.navigator.mozMobileConnections[0];

    if (!this.mobileConnection)
      return;

    if (!IccHelper)
      return;

    this.dialogDone.onclick = this.verify.bind(this);
    this.dialogClose.onclick = this.skip.bind(this);
    this.pinInput = this.getNumberPasswordInputField('simpin');
    this.pukInput = this.getNumberPasswordInputField('simpuk');
    this.xckInput = this.getNumberPasswordInputField('xckpin');
    this.newPinInput = this.getNumberPasswordInputField('newSimpin');
    this.confirmPinInput = this.getNumberPasswordInputField('confirmNewSimpin');
  }
};

SimPinDialog.init();

</code></pre>
        </article>
    </section>




          </div>
      </div>

        <br clear="both">

      <footer>
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-dev</a> on Tue Dec 03 2013 12:36:36 GMT+0800 (CST)
        <br>
      </footer>
      <script> prettyPrint(); </script>
    </div>
  </body>
</html>
